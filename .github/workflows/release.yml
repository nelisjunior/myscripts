# Workflow para criaÃ§Ã£o de releases padronizados
# 
# Este workflow Ã© responsÃ¡vel por publicar releases no GitHub baseado em tags criadas.
# Funciona da seguinte forma:
#
# 1. RELEASES NORMAIS: Tags que comeÃ§am com 'v' (ex: v1.0.0, v2.1.3)
#    - Publicados como releases estÃ¡veis/normais
#    - Recomendados para versÃµes de produÃ§Ã£o
#
# 2. PRE-RELEASES: Tags que contÃªm 'beta' ou 'alpha' (ex: v1.0.0-beta.1, alpha-v0.1.0)
#    - Publicados como pre-releases
#    - Indicados para versÃµes de teste e desenvolvimento
#
# INSTRUÃ‡Ã•ES DE USO:
# - Certifique-se de estar na branch main antes de criar a tag
# - Para release estÃ¡vel: git tag v1.0.0 && git push origin v1.0.0
# - Para pre-release: git tag v1.0.0-beta.1 && git push origin v1.0.0-beta.1
# - Para pre-release alpha: git tag alpha-v0.1.0 && git push origin alpha-v0.1.0
#
# MANUTENÃ‡ÃƒO:
# - Modificar as condiÃ§Ãµes de detecÃ§Ã£o de pre-release na seÃ§Ã£o 'determine-release-type'
# - Ajustar o corpo do release na seÃ§Ã£o 'Create GitHub Release'
# - Atualizar a versÃ£o da action softprops/action-gh-release conforme necessÃ¡rio

name: Create Release

# Trigger: Executa apenas quando uma nova tag Ã© criada
on:
  push:
    tags:
      - '*'  # Qualquer tag

# PermissÃµes necessÃ¡rias para criar releases
permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      # 1. Fazer checkout do cÃ³digo na tag especÃ­fica
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Buscar histÃ³rico completo para geraÃ§Ã£o de changelog

      # 2. Determinar o tipo de release baseado no padrÃ£o da tag
      - name: Determine release type
        id: determine-release-type
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag name: $TAG_NAME"
          
          # Verificar se Ã© pre-release (contÃ©m 'beta' ou 'alpha')
          if [[ "$TAG_NAME" == *"beta"* ]] || [[ "$TAG_NAME" == *"alpha"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_type=Pre-release" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Detected: Pre-release (beta/alpha)"
          # Verificar se Ã© release normal (comeÃ§a com 'v')
          elif [[ "$TAG_NAME" == v* ]]; then
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_type=Release" >> $GITHUB_OUTPUT
            echo "ğŸš€ Detected: Normal release (v*)"
          else
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "release_type=Pre-release" >> $GITHUB_OUTPUT
            echo "âš ï¸  Warning: Tag pattern not recognized, defaulting to pre-release"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      # 3. Gerar changelog baseado nos commits desde a Ãºltima tag
      - name: Generate changelog
        id: generate-changelog
        run: |
          TAG_NAME="${{ steps.determine-release-type.outputs.tag_name }}"
          
          # Buscar a tag anterior
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ğŸ“ First release - showing all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges HEAD)
          else
            echo "ğŸ“ Generating changelog from $PREVIOUS_TAG to $TAG_NAME"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges $PREVIOUS_TAG..HEAD)
          fi
          
          # Criar arquivo temporÃ¡rio para o corpo do release
          RELEASE_FILE="release_body.txt"
          
          # CabeÃ§alho
          echo "## ${{ steps.determine-release-type.outputs.release_type }} $TAG_NAME" > $RELEASE_FILE
          echo "" >> $RELEASE_FILE
          
          # SeÃ§Ã£o de mudanÃ§as
          if [ ! -z "$PREVIOUS_TAG" ]; then
            echo "### MudanÃ§as desde $PREVIOUS_TAG:" >> $RELEASE_FILE
          else
            echo "### Primeira release do projeto:" >> $RELEASE_FILE
          fi
          echo "" >> $RELEASE_FILE
          
          # Lista de commits
          if [ ! -z "$COMMITS" ]; then
            echo "$COMMITS" >> $RELEASE_FILE
          else
            echo "- Sem mudanÃ§as significativas detectadas" >> $RELEASE_FILE
          fi
          echo "" >> $RELEASE_FILE
          
          # Adicionar informaÃ§Ãµes sobre UserScripts se existirem
          if [ -d "userscripts" ]; then
            USERSCRIPT_COUNT=$(find userscripts -name "*.user.js" | wc -l)
            if [ $USERSCRIPT_COUNT -gt 0 ]; then
              echo "### ğŸ“ UserScripts incluÃ­dos:" >> $RELEASE_FILE
              echo "- $USERSCRIPT_COUNT script(s) de usuÃ¡rio atualizado(s)" >> $RELEASE_FILE
              echo "- VersÃ£o sincronizada: $TAG_NAME" >> $RELEASE_FILE
              echo "" >> $RELEASE_FILE
            fi
          fi
          
          # Adicionar instruÃ§Ãµes de instalaÃ§Ã£o
          echo "### ğŸš€ InstalaÃ§Ã£o dos UserScripts:" >> $RELEASE_FILE
          echo "1. Instale [TamperMonkey](https://www.tampermonkey.net/) em seu navegador" >> $RELEASE_FILE
          echo "2. Clique nos links dos arquivos .user.js nesta release" >> $RELEASE_FILE
          echo "3. Confirme a instalaÃ§Ã£o no TamperMonkey" >> $RELEASE_FILE
          echo "" >> $RELEASE_FILE
          echo "### ğŸ“š DocumentaÃ§Ã£o:" >> $RELEASE_FILE
          echo "- [README.md](README.md) - VisÃ£o geral do projeto" >> $RELEASE_FILE
          echo "- [VERSIONING.md](VERSIONING.md) - Sistema de versionamento" >> $RELEASE_FILE
          echo "- [userscripts/README.md](userscripts/README.md) - DocumentaÃ§Ã£o dos UserScripts" >> $RELEASE_FILE
          
          echo "âœ… Changelog generated successfully"

      # 4. Criar o release no GitHub usando softprops/action-gh-release@v2
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.determine-release-type.outputs.tag_name }}
          name: ${{ steps.determine-release-type.outputs.release_type }} ${{ steps.determine-release-type.outputs.tag_name }}
          body_path: release_body.txt
          prerelease: ${{ steps.determine-release-type.outputs.is_prerelease }}
          draft: false
          # Anexar todos os arquivos UserScript como assets
          files: |
            userscripts/*.user.js
            VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. Log de confirmaÃ§Ã£o
      - name: Release created successfully
        run: |
          echo "âœ… ${{ steps.determine-release-type.outputs.release_type }} created successfully!"
          echo "ğŸ·ï¸  Tag: ${{ steps.determine-release-type.outputs.tag_name }}"
          echo "ğŸ”— Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.determine-release-type.outputs.tag_name }}"
          echo "ğŸ“¦ Pre-release: ${{ steps.determine-release-type.outputs.is_prerelease }}"